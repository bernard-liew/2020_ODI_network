---
title: "3-report"
author: "bernard-liew"
date: "2020-10-09"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Load package

```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,
               qgraph,
               stats,
               bootnet,
               igraph,
               plotrix,
               mgm,
               NetworkComparisonTest,
               rio,
               furrr,
               cowplot,
               doParallel,
               huge,
               EGAnet)
```

## Report network without group as variable

### ODI labels

```{r}
# ODI custom figure
nodeLabels <- c("Pain Intensity", "Personal Care", "Lifting", "Walking", "Sitting",
                "Standing", "Sleeping", "Sex life", "Social life", "Travelling")
ques <- paste0("Q", 1:10)

node_df <- data.frame("Item" = ques,
                      "Variable" = nodeLabels)
```


### Load models

```{r}
# Model with missing data as input
res <- readRDS("output/raw.RDS")
# Model with complete imputed data as input
#res <- readRDS("output/com.RDS")
```

### Plot network

Blue edges - positive correlation

Red edges - negative correlation

The thickness of the edges indicate the magnitude of correlation.

```{r}

#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_network.tiff")
par (mfrow = c(2,3))
p1 <- plot (res$nw[[1]], title = "Baseline", label.cex = 1.5, vsize = 10)
plot (res$nw[[2]], title = "Week 5", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot (res$nw[[3]], title = "Week 10", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot (res$nw[[4]], title = "Week 26", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot (res$nw[[5]], title = "Week 52", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot.new()
addtable2plot(0,0,node_df, 
              xpad=1, ypad=1,
              bty='o',
              display.rownames = FALSE, 
              hlines = TRUE,
              vlines = TRUE)
#dev.off()

```

### Plot centrality

Strength - sum of direct connections a given node has in the network

Betweenness - shortest paths that go through the node under investigation

Closeness - sum of shortest paths from the node under investigation to all other nodes in the network

Expected influence - sum of a node's connections and represents the relative importance of a node in a network

```{r}
# Plot centrality
c_fig <- map (res$nw, centralityPlot, include = "all", print = FALSE)
#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_strength.tiff")
cowplot::plot_grid(plotlist = c_fig, labels = c("Wk0","Wk 5", "Wk 10", "Wk 26", "wk52" ), vjust = 1, hjust = 0)
#dev.off()

```

### Plot centrality stability

Is the centrality order stable?

```{r}
# Plot centrality stability
s_fig <- map (res$centr_stb, plot, statistics = c("closeness", "strength", "betweenness"))
#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_stability.tiff")
cowplot::plot_grid(plotlist = s_fig, labels = c("Wk0","Wk 5", "Wk 10", "Wk 26", "wk52" ), vjust = 1, hjust = -1)
#dev.off()

```

### Get CS coefficient

The stability of centrality estimation, and results in a centrality-stability coefficient (CS-coefficient) that should not be lower than 0.25 and preferably above 0.5


```{r}
cs_coef <- res %>%
  select (time, cor_stb) %>%
  unnest () %>%
  ungroup() %>%
  mutate (measure = rep (c("betweenness", "closeness", "edge", "expectedInfluence", "strength"), 5))

```

### Plot edge weights stability

See which edges differ from each other in size significantly (to answer the question is edge A significantly larger than edge B).

```{r}
w_fig <- map (res$edgewts, plot, labels = FALSE)
cowplot::plot_grid(plotlist = w_fig, labels = c("Wk0","Wk 5", "Wk 10", "Wk 26", "wk52" ), vjust = 1, hjust = -1)

```

## Report network with group as variable

### Load models

```{r}
# Model with missing data as input
res <- readRDS("output/mgm_raw.RDS")
# Model with complete imputed data as input
#res <- readRDS("output/com.RDS")
```

### Plot network

Blue edges - positive correlation

Red edges - negative correlation

The thickness of the edges indicate the magnitude of correlation.

```{r}

#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_network.tiff")
par (mfrow = c(2,3))
p1 <- plot (res$nw[[1]], title = "Baseline", label.cex = 1.5, vsize = 10)
plot (res$nw[[2]], title = "Week 5", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot (res$nw[[3]], title = "Week 10", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot (res$nw[[4]], title = "Week 26", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot (res$nw[[5]], title = "Week 52", layout = p1$layout, label.cex = 1.5, vsize = 10)
plot.new()
addtable2plot(0,0,node_df, 
              xpad=1, ypad=1,
              bty='o',
              display.rownames = FALSE, 
              hlines = TRUE,
              vlines = TRUE)
#dev.off()

```

### Plot centrality

Strength - sum of direct connections a given node has in the network

Betweenness - shortest paths that go through the node under investigation

Closeness - sum of shortest paths from the node under investigation to all other nodes in the network

Expected influence - sum of a node's connections and represents the relative importance of a node in a network

```{r}
# Plot centrality
c_fig <- map (res$nw, centralityPlot, include = "all", print = FALSE)
#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_strength.tiff")
cowplot::plot_grid(plotlist = c_fig, labels = c("Wk0","Wk 5", "Wk 10", "Wk 26", "wk52" ), vjust = 1, hjust = 0)
#dev.off()

```

### Plot centrality stability

Is the centrality order stable?

```{r}
# Plot centrality stability
s_fig <- map (res$centr_stb, plot, statistics = c("closeness", "strength", "betweenness"))
#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_stability.tiff")
cowplot::plot_grid(plotlist = s_fig, labels = c("Wk0","Wk 5", "Wk 10", "Wk 26", "wk52" ), vjust = 1, hjust = -1)
#dev.off()

```

### Get CS coefficient

The stability of centrality estimation, and results in a centrality-stability coefficient (CS-coefficient) that should not be lower than 0.25 and preferably above 0.5

```{r}
cs_coef <- res %>%
  select (time, cor_stb) %>%
  unnest () %>%
  ungroup() %>%
  mutate (measure = rep (c("betweenness", "closeness", "edge", "expectedInfluence", "strength"), 5))

```

### Plot edge weights stability

See which edges differ from each other in size significantly (to answer the question is edge A significantly larger than edge B).

```{r}
w_fig <- map (res$edgewts, plot, labels = FALSE)
cowplot::plot_grid(plotlist = w_fig, labels = c("Wk0","Wk 5", "Wk 10", "Wk 26", "wk52" ), vjust = 1, hjust = -1)

```
